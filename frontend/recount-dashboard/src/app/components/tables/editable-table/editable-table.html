<div class="editable-table-wrapper">
  <!-- Loading State -->
  <div *ngIf="loading" class="table-loading">
    <div class="loading-spinner"></div>
    <span class="loading-text">Cargando...</span>
  </div>

  <!-- Table -->
  <div class="table-container" *ngIf="!loading">
    <table class="editable-table">
      <thead>
        <tr>
          <th *ngFor="let column of columns"
              [style.width]="column.width || 'auto'"
              [class.table-header]="true"
              [class.sortable]="isSortable(column)"
              [style.cursor]="isSortable(column) ? 'pointer' : 'default'"
              (click)="isSortable(column) ? onHeaderClick(column) : null">
            {{ column.label }}
            <span *ngIf="isSortable(column) && getSortIndicator(column)" style="margin-left: 4px;">
              {{ getSortIndicator(column) }}
            </span>
          </th>
          <th class="table-header table-header-actions" *ngIf="canEdit || canDelete">
            Acciones
          </th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let item of data; let i = index; trackBy: trackByFn"
            [class.editing-row]="isEditing(i)"
            class="table-row">

          <!-- Data Columns -->
          <td *ngFor="let column of columns"
              [style.width]="column.width || 'auto'"
              class="table-cell">
            <!-- View Mode -->
            <div *ngIf="!isEditing(i)" class="cell-content">
              <div *ngIf="column.type === 'custom' && column.customRenderer; else defaultView">
                <!-- Custom renderer for balances -->
                <div *ngIf="column.customRenderer(getColumnValue(item, column), item)?.compact; else simpleCustom"
                     class="balance-chips-container">
                  <div class="balance-count">
                    {{ column.customRenderer(getColumnValue(item, column), item)?.items?.length || 0 }} monedas
                  </div>
                  <div class="balance-chips">
                    <span *ngFor="let balanceItem of column.customRenderer(getColumnValue(item, column), item)?.visualBreakdown || []"
                          class="balance-chip"
                          [class.positive]="balanceItem.isPositive && !balanceItem.isZero"
                          [class.negative]="!balanceItem.isPositive && !balanceItem.isZero"
                          [class.zero]="balanceItem.isZero">
                      <span class="chip-currency">{{ balanceItem.currency }}</span>
                      <span class="chip-amount">{{ balanceItem.formatted }}</span>
                    </span>
                  </div>
                </div>
                <ng-template #simpleCustom>
                  <div class="cell-text"
                       [innerHTML]="column.customRenderer(getColumnValue(item, column), item)?.display || formatValue(getColumnValue(item, column), column)">
                  </div>
                </ng-template>
              </div>
              <ng-template #defaultView>
                <ng-container *ngIf="column.key === 'name'; else normalCell">
                  <span class="clickable-cell"
                        (click)="onCellClick(item, column, i)">
                    {{ column.formatter ? column.formatter(getColumnValue(item, column), item) : formatValue(getColumnValue(item, column), column) }}
                  </span>
                </ng-container>
                <ng-template #normalCell>
                  <span class="cell-text" [class.empty]="!getColumnValue(item, column)">
                    {{ column.formatter ? column.formatter(getColumnValue(item, column), item) : formatValue(getColumnValue(item, column), column) }}
                  </span>
                </ng-template>
              </ng-template>
            </div>

            <!-- Edit Mode -->
            <div *ngIf="isEditing(i) && column.editable !== false" class="edit-mode">
              <!-- Text Input -->
              <input *ngIf="column.type === 'text' || column.type === 'number'"
                     [type]="column.type"
                     [value]="getColumnValue(editedItem, column)"
                     (input)="setColumnValue($any($event.target).value, column)"
                     class="table-input"
                     [required]="column.required">

              <!-- Currency Input -->
              <input *ngIf="column.type === 'currency'"
                     type="number"
                     step="0.01"
                     [value]="getColumnValue(editedItem, column)"
                     (input)="setColumnValue($any($event.target).value, column)"
                     class="table-input"
                     [required]="column.required">

              <!-- Date Input -->
              <input *ngIf="column.type === 'date'"
                     type="date"
                     [value]="getColumnValue(editedItem, column) | date:'yyyy-MM-dd'"
                     (input)="setColumnValue($any($event.target).value, column)"
                     class="table-input"
                     [required]="column.required">

              <!-- Select Dropdown -->
              <select *ngIf="column.type === 'select' && column.options"
                      [value]="getColumnValue(editedItem, column)"
                      (change)="setColumnValue($any($event.target).value, column)"
                      class="table-input table-select"
                      [required]="column.required">
                <option *ngFor="let option of column.options" [value]="option.value">
                  {{ option.label }}
                </option>
              </select>

              <!-- Boolean Checkbox -->
              <input *ngIf="column.type === 'boolean'"
                     type="checkbox"
                     [checked]="getColumnValue(editedItem, column)"
                     (change)="setColumnValue($any($event.target).checked, column)"
                     class="table-checkbox">
            </div>
          </td>

          <!-- Actions Column -->
          <td class="table-cell table-cell-actions" *ngIf="canEdit || canDelete">
            <div class="action-buttons">
              <!-- Edit/Save/Cancel Buttons -->
              <button *ngIf="canEdit && !isEditing(i)"
                      (click)="startEdit(item, i)"
                      class="action-btn action-btn-edit"
                      title="Editar">
                <i class="fas fa-edit"></i>
              </button>

              <button *ngIf="isEditing(i)"
                      (click)="saveEdit()"
                      class="action-btn action-btn-save"
                      title="Guardar">
                <i class="fas fa-check"></i>
              </button>

              <button *ngIf="isEditing(i)"
                      (click)="cancelEdit()"
                      class="action-btn action-btn-cancel"
                      title="Cancelar">
                <i class="fas fa-times"></i>
              </button>

              <!-- Delete Button -->
              <button *ngIf="canDelete && !isEditing(i)"
                      (click)="confirmDelete(item, i)"
                      class="action-btn action-btn-delete"
                      title="Eliminar">
                <i class="fas fa-trash"></i>
              </button>
            </div>
          </td>
        </tr>

        <!-- Empty State -->
        <tr *ngIf="data.length === 0" class="empty-row">
          <td [attr.colspan]="columns.length + (canEdit || canDelete ? 1 : 0)"
              class="empty-state">
            <div class="empty-state-content">
              <i class="fas fa-inbox empty-state-icon"></i>
              <p class="empty-state-text">No hay datos disponibles</p>
            </div>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>
