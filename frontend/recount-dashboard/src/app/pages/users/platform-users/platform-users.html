<div page-content>
  <!-- Alerts -->
  <div *ngIf="successMessage" class="alert alert-success">{{ successMessage }}</div>
  <div *ngIf="errorMessage" class="alert alert-error">{{ errorMessage }}</div>

  <!-- Header -->
  <div class="card" style="margin-bottom: var(--space-4);">
    <div class="card-header">
      <div class="flex-between">
        <h3>Usuarios</h3>
        <button *ngIf="canCreateUsers()" class="btn btn-primary" (click)="openCreateModal()">
          Crear usuario
        </button>
      </div>
    </div>
  </div>

  <!-- Users List -->
  <div class="card">
    <div class="card-body">
      <div *ngIf="loading" class="text-center" style="padding: var(--space-8) 0;">
        <span class="loading" style="width: 40px; height: 40px;"></span>
        <p style="margin-top: var(--space-3); color: var(--color-gray-500);">Cargando usuarios...</p>
      </div>

      <div *ngIf="!loading && users.length === 0" class="text-center text-muted" style="padding: var(--space-8) 0;">
        No se han creado usuarios aún. Haz clic en "Crear usuario" para agregar el primer usuario.
      </div>

      <table class="table" *ngIf="!loading && users.length > 0">
        <thead>
          <tr>
            <th>Nombre</th>
            <th>Email</th>
            <th>Rol</th>
            <th>Creado</th>
            <th *ngIf="canCreateUsers()" style="text-align: right;">Acciones</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let user of users">
            <td>{{ user.name }}</td>
            <td>{{ user.email }}</td>
            <td>{{ getRoleLabel(user.role) }}</td>
            <td style="font-size: var(--font-xs);">{{ formatDate(user.createdAt) }}</td>
            <td *ngIf="canCreateUsers()" style="text-align: right;">
              <button class="btn btn-sm btn-primary" (click)="openEditModal(user)" style="margin-right: var(--space-1);">
                Editar
              </button>
              <button class="btn btn-sm btn-danger" (click)="openDeleteModal(user)" [disabled]="isCurrentUser(user)">
                Eliminar
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Create User Modal -->
  <div *ngIf="showCreateModal" class="modal-overlay" (click)="!creatingUser && closeCreateModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Crear nuevo usuario</h3>
        <button class="btn-close" (click)="closeCreateModal()" [disabled]="creatingUser">&times;</button>
      </div>

      <form (ngSubmit)="createUser()" #userForm="ngForm">
        <div class="modal-body">
          <div *ngIf="errorMessage" class="alert alert-error" style="margin-bottom: var(--space-3);">
            {{ errorMessage }}
          </div>

          <div class="form-group">
            <label class="form-label">Nombre completo *</label>
            <input type="text" class="form-control" [(ngModel)]="newUser.name" name="name" required placeholder="John Doe" #nameInput="ngModel" [disabled]="creatingUser">
            <small *ngIf="nameInput.invalid && nameInput.touched" style="color: var(--color-error); font-size: var(--font-xs);">
              El nombre completo es requerido
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Correo electrónico *</label>
            <input type="email" class="form-control" [(ngModel)]="newUser.email" name="email" required email placeholder="john@example.com" #emailInput="ngModel" [disabled]="creatingUser">
            <small *ngIf="emailInput.invalid && emailInput.touched" style="color: var(--color-error); font-size: var(--font-xs);">
              <span *ngIf="emailInput.errors?.['required']">El correo electrónico es requerido</span>
              <span *ngIf="emailInput.errors?.['email']">Formato de correo electrónico inválido</span>
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Contraseña *</label>
            <input type="password" class="form-control" [(ngModel)]="newUser.password" name="password" required placeholder="Minimum 6 characters" minlength="6" #passwordInput="ngModel" [disabled]="creatingUser">
            <small *ngIf="!passwordInput.invalid || !passwordInput.touched" style="font-size: var(--font-xs); color: var(--color-gray-500);">
              La contraseña debe tener al menos 6 caracteres
            </small>
            <small *ngIf="passwordInput.invalid && passwordInput.touched" style="color: var(--color-error); font-size: var(--font-xs);">
              <span *ngIf="passwordInput.errors?.['required']">La contraseña es requerida</span>
              <span *ngIf="passwordInput.errors?.['minlength']">La contraseña debe tener al menos 6 caracteres</span>
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Rol *</label>
            <select class="form-control" [(ngModel)]="newUser.role" name="role" required #roleInput="ngModel" [disabled]="creatingUser">
              <option value="">Seleccionar un rol</option>
              <option value="viewer">Viewer (Solo lectura)</option>
              <option value="reviewer">Reviewer (Editar permisos)</option>
              <option value="super_admin">Super Admin (Acceso completo)</option>
            </select>
            <small *ngIf="roleInput.invalid && roleInput.touched" style="color: var(--color-error); font-size: var(--font-xs);">
              El rol es requerido
            </small>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-sm" (click)="closeCreateModal()" [disabled]="creatingUser">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary btn-sm" [disabled]="creatingUser || !userForm.valid">
            <span *ngIf="creatingUser" class="loading" style="width: 12px; height: 12px;"></span>
            {{ creatingUser ? 'Creando...' : 'Crear usuario' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Edit User Modal -->
  <div *ngIf="showEditModal" class="modal-overlay" (click)="!updatingUser && closeEditModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h3>Editar usuario</h3>
        <button class="btn-close" (click)="closeEditModal()" [disabled]="updatingUser">&times;</button>
      </div>

      <form (ngSubmit)="updateUserData()" #editForm="ngForm">
        <div class="modal-body">
          <div *ngIf="errorMessage" class="alert alert-error" style="margin-bottom: var(--space-3);">
            {{ errorMessage }}
          </div>

          <div class="form-group">
            <label class="form-label">Nombre completo *</label>
            <input type="text" class="form-control" [(ngModel)]="editUser.name" name="editName" required [disabled]="updatingUser">
          </div>

          <div class="form-group">
            <label class="form-label">Correo electrónico *</label>
            <input type="email" class="form-control" [(ngModel)]="editUser.email" name="editEmail" required email [disabled]="updatingUser">
          </div>

          <div class="form-group">
            <label class="form-label">Nueva contraseña (opcional)</label>
            <input type="password" class="form-control" [(ngModel)]="editUser.password" name="editPassword" placeholder="Dejar en blanco para mantener la actual" minlength="6" [disabled]="updatingUser">
            <small style="font-size: var(--font-xs); color: var(--color-gray-500);">
              Dejar en blanco si no deseas cambiar la contraseña
            </small>
          </div>

          <div class="form-group">
            <label class="form-label">Rol *</label>
            <select class="form-control" [(ngModel)]="editUser.role" name="editRole" required [disabled]="updatingUser">
              <option value="viewer">Viewer (Solo lectura)</option>
              <option value="reviewer">Reviewer (Editar permisos)</option>
              <option value="super_admin">Super Admin (Acceso completo)</option>
            </select>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-sm" (click)="closeEditModal()" [disabled]="updatingUser">
            Cancelar
          </button>
          <button type="submit" class="btn btn-primary btn-sm" [disabled]="updatingUser || !isEditFormValid()">
            <span *ngIf="updatingUser" class="loading" style="width: 12px; height: 12px;"></span>
            {{ updatingUser ? 'Actualizando...' : 'Guardar cambios' }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Delete Confirmation Modal -->
  <div *ngIf="showDeleteModal" class="modal-overlay" (click)="!deletingUser && closeDeleteModal()">
    <div class="modal-content" (click)="$event.stopPropagation()" style="max-width: 500px;">
      <div class="modal-header">
        <h3>Confirmar eliminación</h3>
        <button class="btn-close" (click)="closeDeleteModal()" [disabled]="deletingUser">&times;</button>
      </div>

      <div class="modal-body">
        <div *ngIf="errorMessage" class="alert alert-error" style="margin-bottom: var(--space-3);">
          {{ errorMessage }}
        </div>

        <p style="margin-bottom: var(--space-3);">
          ¿Estás seguro de que deseas eliminar al usuario <strong>{{ selectedUser?.name }}</strong>?
        </p>
        <p style="color: var(--color-error); font-size: var(--font-sm);">
          Esta acción no se puede deshacer.
        </p>
      </div>

      <div class="modal-footer">
        <button type="button" class="btn btn-sm" (click)="closeDeleteModal()" [disabled]="deletingUser">
          Cancelar
        </button>
        <button type="button" class="btn btn-danger btn-sm" (click)="confirmDelete()" [disabled]="deletingUser">
          <span *ngIf="deletingUser" class="loading" style="width: 12px; height: 12px;"></span>
          {{ deletingUser ? 'Eliminando...' : 'Eliminar usuario' }}
        </button>
      </div>
    </div>
  </div>
</div>
