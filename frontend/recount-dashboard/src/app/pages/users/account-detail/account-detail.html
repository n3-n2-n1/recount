<!-- Account Detail Page -->
<div page-content>

  <!-- Header -->
  <div class="account-header">
    <button class="btn" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <h2 *ngIf="account">{{ account.name }}</h2>
    <h2 *ngIf="!account">Detalles de la Cuenta</h2>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <span class="loading"></span>
    <p>Cargando información...</p>
  </div>

  <!-- Account Information -->
  <div *ngIf="!loading && account">

    <!-- Account Summary Card -->
    <div class="card account-summary">
      <div class="card-body">
        <div class="summary-grid">

          <!-- Account Balances -->
          <div class="summary-section">
            <h4>Balances por Moneda</h4>

            <!-- Currency selector -->
            <div *ngIf="!loadingRates && exchangeRates.length > 0" class="currency-selector">
              <select [(ngModel)]="preferredCurrency" (change)="onPreferredCurrencyChange()" class="form-control">
                <option *ngFor="let currency of currencies" [value]="currency">
                  Ver en {{ currency }}
                </option>
              </select>
            </div>

            <div class="balances-list" *ngIf="getAccountBalances().length > 0; else noBalances">
              <!-- With exchange rates -->
              <ng-container *ngIf="exchangeRates.length > 0">
                <div *ngFor="let balance of getBalancesWithConversion()" class="balance-item">
                  <div class="balance-main">
                    <span class="balance-currency">{{ balance.currency }}:</span>
                    <span class="balance-amount" [class]="balance.amount > 0 ? 'positive' : balance.amount < 0 ? 'negative' : ''">
                      {{ balance.amount | number:'1.2-2' }}
                    </span>
                  </div>
                  <div *ngIf="balance.currency !== preferredCurrency && balance.convertedAmount !== undefined" class="balance-converted">
                    ≈ {{ balance.convertedAmount | number:'1.2-2' }} {{ preferredCurrency }}
                  </div>
                </div>
              </ng-container>

              <!-- Without exchange rates -->
              <ng-container *ngIf="exchangeRates.length === 0">
                <div *ngFor="let balance of getAccountBalances(); trackBy: trackByBalance" class="balance-item">
                  <div class="balance-main">
                    <span class="balance-currency">{{ balance.currency }}:</span>
                    <span class="balance-amount" [class]="balance.amount > 0 ? 'positive' : balance.amount < 0 ? 'negative' : ''">
                      {{ balance.amount | number:'1.2-2' }}
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>

            <ng-template #noBalances>
              <div class="no-balances">
                <i class="fas fa-wallet"></i>
                <span>Sin balances</span>
              </div>
            </ng-template>
          </div>

          <!-- Total Balance -->
          <div class="summary-section">
            <h4>Balance Total</h4>
            <div class="total-balance" [class]="getTotalBalance() > 0 ? 'positive' : getTotalBalance() < 0 ? 'negative' : ''">
              {{ getTotalBalance() | number:'1.2-2' }}
            </div>

            <div *ngIf="!loadingRates && exchangeRates.length > 0" class="converted-total">
              <div class="converted-label">En {{ preferredCurrency }}</div>
              <div class="converted-amount" [class]="getTotalBalanceConverted() > 0 ? 'positive' : getTotalBalanceConverted() < 0 ? 'negative' : ''">
                {{ getTotalBalanceConverted() | number:'1.2-2' }}
              </div>
            </div>
          </div>

          <!-- Account Info -->
          <div class="summary-section">
            <h4>Información</h4>
            <div class="account-info">
              <div class="info-item">
                <span class="info-label">Creada:</span>
                <span class="info-value">{{ formatDate(account.createdAt) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Actualizada:</span>
                <span class="info-value">{{ formatDate(account.updatedAt) }}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Transacciones:</span>
                <span class="info-value">{{ transactions.length }}</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Transactions History -->
    <div class="card">
      <div class="card-header">
        <h3>Historial de Transacciones</h3>
      </div>
      <div class="card-body">

        <!-- Empty State -->
        <div *ngIf="transactions.length === 0" class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>No hay transacciones para esta cuenta</p>
        </div>

        <!-- Transactions Table -->
        <div *ngIf="transactions.length > 0" class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Moneda</th>
                <th class="text-right">Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let transaction of transactions">
                <td>{{ formatDate(transaction.createdAt) }}</td>
                <td>
                  <span class="transaction-type" [class]="getTransactionTypeClass(transaction.type)">
                    {{ transaction.type }}
                  </span>
                </td>
                <td>{{ transaction.description || '-' }}</td>
                <td>{{ transaction.currency }}</td>
                <td class="text-right">
                  <span class="amount" [class]="getTransactionTypeClass(transaction.type)">
                    <span *ngIf="transaction.type === 'Entrada'">+</span>
                    <span *ngIf="transaction.type === 'Salida'">-</span>
                    {{ transaction.amount | number:'1.2-2' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

</div>
