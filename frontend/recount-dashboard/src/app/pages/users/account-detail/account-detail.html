<!-- Account Detail Page -->
<div page-content>

  <!-- Header -->
  <div class="account-header">
    <button class="btn" (click)="goBack()">
      <i class="fas fa-arrow-left"></i> Volver
    </button>
    <h2 *ngIf="account">{{ account.name }}</h2>
    <h2 *ngIf="!account">Detalles de la Cuenta</h2>
  </div>

  <!-- Error Message -->
  <div *ngIf="error" class="alert alert-error">
    {{ error }}
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <span class="loading"></span>
    <p>Cargando información...</p>
  </div>

  <!-- Account Information -->
  <div *ngIf="!loading && account">

    <!-- Account Summary Card -->
    <div class="card">
      <div class="card-header">
        <h3>Resumen de la Cuenta</h3>
      </div>
      <div class="card-body">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-4);">

          <!-- Balances -->
          <div>
            <label class="form-label">Balances por Moneda</label>

            <!-- Currency selector -->
            <div *ngIf="!loadingRates && exchangeRates.length > 0" style="margin-bottom: var(--space-3);">
              <select [(ngModel)]="preferredCurrency" (change)="onPreferredCurrencyChange()" class="form-control" style="max-width: 180px;">
                <option *ngFor="let currency of currencies" [value]="currency">
                  Ver en {{ currency }}
                </option>
              </select>
            </div>

            <div *ngIf="getAccountBalances().length > 0">
              <!-- With exchange rates -->
              <ng-container *ngIf="exchangeRates.length > 0">
                <div *ngFor="let balance of getBalancesWithConversion()" style="padding: var(--space-2); margin-bottom: var(--space-1); background: var(--color-gray-50); border-radius: var(--border-radius);">
                  <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--space-1);">
                    <strong>{{ balance.currency }}:</strong>
                    <span [class]="balance.amount > 0 ? 'text-success' : balance.amount < 0 ? 'text-error' : ''">
                      {{ balance.amount | number:'1.2-2' }}
                    </span>
                  </div>
                  <div *ngIf="balance.currency !== preferredCurrency && balance.convertedAmount !== undefined" style="font-size: 0.75rem; color: var(--color-gray-600); font-style: italic;">
                    ≈ {{ balance.convertedAmount | number:'1.2-2' }} {{ preferredCurrency }}
                  </div>
                </div>
              </ng-container>

              <!-- Without exchange rates -->
              <ng-container *ngIf="exchangeRates.length === 0">
                <div *ngFor="let balance of getAccountBalances(); trackBy: trackByBalance" style="padding: var(--space-2); margin-bottom: var(--space-1); background: var(--color-gray-50); border-radius: var(--border-radius);">
                  <div style="display: flex; justify-content: space-between; align-items: center;">
                    <strong>{{ balance.currency }}:</strong>
                    <span [class]="balance.amount > 0 ? 'text-success' : balance.amount < 0 ? 'text-error' : ''">
                      {{ balance.amount | number:'1.2-2' }}
                    </span>
                  </div>
                </div>
              </ng-container>
            </div>

            <div *ngIf="getAccountBalances().length === 0" class="text-muted" style="padding: var(--space-3); text-align: center;">
              Sin balances
            </div>
          </div>

          <!-- Total Balance -->
          <div>
            <label class="form-label">Balance Total</label>
            <div style="font-size: 1.5rem; font-weight: 600; margin-bottom: var(--space-2);" [class]="getTotalBalance() > 0 ? 'text-success' : getTotalBalance() < 0 ? 'text-error' : ''">
              {{ getTotalBalance() | number:'1.2-2' }}
            </div>

            <div *ngIf="!loadingRates && exchangeRates.length > 0" style="margin-top: var(--space-3); padding-top: var(--space-3); border-top: 1px solid var(--border-color);">
              <label class="form-label" style="font-size: 0.875rem;">Total en {{ preferredCurrency }}</label>
              <div style="font-size: 1.2rem; font-weight: 600;" [class]="getTotalBalanceConverted() > 0 ? 'text-success' : getTotalBalanceConverted() < 0 ? 'text-error' : ''">
                {{ getTotalBalanceConverted() | number:'1.2-2' }}
              </div>
            </div>
          </div>

          <!-- Account Info -->
          <div>
            <label class="form-label">Información</label>
            <div style="display: flex; flex-direction: column; gap: var(--space-2);">
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-gray-600);">Creada:</span>
                <span>{{ formatDate(account.createdAt) }}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-gray-600);">Actualizada:</span>
                <span>{{ formatDate(account.updatedAt) }}</span>
              </div>
              <div style="display: flex; justify-content: space-between;">
                <span style="color: var(--color-gray-600);">Transacciones:</span>
                <span>{{ transactions.length }}</span>
              </div>
            </div>
          </div>

        </div>
      </div>
    </div>

    <!-- Transactions History -->
    <div class="card">
      <div class="card-header">
        <h3>Historial de Transacciones</h3>
      </div>
      <div class="card-body">

        <!-- Empty State -->
        <div *ngIf="transactions.length === 0" class="empty-state">
          <i class="fas fa-inbox"></i>
          <p>No hay transacciones para esta cuenta</p>
        </div>

        <!-- Transactions Table -->
        <div *ngIf="transactions.length > 0" class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Tipo</th>
                <th>Descripción</th>
                <th>Moneda</th>
                <th class="text-right">Monto</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let transaction of transactions">
                <td>{{ formatDate(transaction.createdAt) }}</td>
                <td>
                  <span class="transaction-type" [class]="getTransactionTypeClass(transaction.type)">
                    {{ transaction.type }}
                  </span>
                </td>
                <td>{{ transaction.description || '-' }}</td>
                <td>{{ transaction.currency }}</td>
                <td class="text-right">
                  <span class="amount" [class]="getTransactionTypeClass(transaction.type)">
                    <span *ngIf="transaction.type === 'Entrada'">+</span>
                    <span *ngIf="transaction.type === 'Salida'">-</span>
                    {{ transaction.amount | number:'1.2-2' }}
                  </span>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

      </div>
    </div>

  </div>

</div>
