<!-- Simple History Page -->
<div page-content>

  <!-- Filters -->
  <div class="card" style="margin-bottom: var(--space-4);">
    <div class="card-header">
      <div class="flex-between">
        <h3>Filtros</h3>
        <div style="display: flex; gap: var(--space-2);">
          <button class="btn" (click)="clearFilters()" [disabled]="loading || !hasActiveFilters()">Limpiar</button>
          <button class="btn btn-primary" (click)="exportTransactions()" [disabled]="loading || filteredTransactions.length === 0">Exportar</button>
        </div>
      </div>
    </div>
    <div class="card-body">
      <!-- Search -->
      <div style="margin-bottom: var(--space-3);">
        <input type="text" placeholder="Buscar transacciones..." class="form-control"
               [(ngModel)]="searchTerm" (input)="onSearchChange()" [disabled]="loading">
      </div>

      <!-- Filter Grid -->
      <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: var(--space-3);">
        <div class="form-group">
          <label class="form-label">Cuenta</label>
          <select class="form-control" [(ngModel)]="filters.accountId" (change)="onFilterChange()" [disabled]="loading">
            <option value="">Todas las cuentas</option>
            <option *ngFor="let account of accounts" [value]="account._id">{{ account.name }}</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Tipo</label>
          <select class="form-control" [(ngModel)]="filters.type" (change)="onFilterChange()" [disabled]="loading">
            <option value="">Todos los tipos</option>
            <option *ngFor="let type of transactionTypes" [value]="type">{{ type }}</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Moneda</label>
          <select class="form-control" [(ngModel)]="filters.currency" (change)="onFilterChange()" [disabled]="loading">
            <option value="">Todas</option>
            <option *ngFor="let currency of currencies" [value]="currency">{{ currency }}</option>
          </select>
        </div>

        <div class="form-group">
          <label class="form-label">Fecha de inicio</label>
          <input type="date" class="form-control" [(ngModel)]="filters.dateFrom" (change)="onLocalFilterChange()" [disabled]="loading">
        </div>

        <div class="form-group">
          <label class="form-label">Fecha de fin</label>
          <input type="date" class="form-control" [(ngModel)]="filters.dateTo" (change)="onLocalFilterChange()" [disabled]="loading">
        </div>

        <div class="form-group">
          <label class="form-label">Monto mínimo</label>
          <input type="number" class="form-control" step="0.01" placeholder="0.00"
                 [(ngModel)]="filters.amountMin" (change)="onLocalFilterChange()" [disabled]="loading">
        </div>

        <div class="form-group">
          <label class="form-label">Monto máximo</label>
          <input type="number" class="form-control" step="0.01" placeholder="Sin límite"
                 [(ngModel)]="filters.amountMax" (change)="onLocalFilterChange()" [disabled]="loading">
        </div>
      </div>
    </div>
  </div>

  <!-- Results -->
  <div class="card">
    <div class="card-header">
      <div class="flex-between">
        <h3>Transacciones <span *ngIf="!loading">({{ totalItems }})</span></h3>
        <div style="display: flex; gap: var(--space-2); align-items: center;">
          <span style="font-size: var(--font-sm);">Mostrar:</span>
          <select class="form-control" style="width: 80px;" [(ngModel)]="itemsPerPage" (change)="changeItemsPerPage(itemsPerPage)" [disabled]="loading">
            <option [value]="10">10</option>
            <option [value]="25">25</option>
            <option [value]="50">50</option>
            <option [value]="100">100</option>
          </select>
        </div>
      </div>
    </div>
    <div class="card-body">
      <div *ngIf="loading" class="text-center" style="padding: var(--space-8) 0;">
        <span class="loading" style="width: 40px; height: 40px;"></span>
        <p style="margin-top: var(--space-3); color: var(--color-gray-500);">Cargando transacciones...</p>
      </div>

      <div *ngIf="!loading && filteredTransactions.length === 0" class="text-center text-muted">
        No se encontraron transacciones que coincidan con tus criterios.
      </div>

      <div *ngIf="!loading && filteredTransactions.length > 0">
        <table class="table">
          <thead>
            <tr>
              <th style="cursor: pointer;" (click)="setSortBy('createdAt')">
                Fecha
                <span *ngIf="sortBy === 'createdAt'">{{ sortOrder === 'asc' ? '↑' : '↓' }}</span>
              </th>
              <th>Cuenta</th>
              <th style="cursor: pointer;" (click)="setSortBy('type')">
                Tipo
                <span *ngIf="sortBy === 'type'">{{ sortOrder === 'asc' ? '↑' : '↓' }}</span>
              </th>
              <th style="cursor: pointer;" (click)="setSortBy('amount')">
                Monto
                <span *ngIf="sortBy === 'amount'">{{ sortOrder === 'asc' ? '↑' : '↓' }}</span>
              </th>
              <th>Moneda</th>
              <th>Descripción</th>
              <th>Creado por</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of getCombinedHistory()">
              <!-- Transaction rows -->
              <ng-container *ngIf="item.type === 'transaction'">
                <td style="font-family: monospace; font-size: var(--font-xs);">
                  {{ formatDate(item.data.createdAt) }}
                </td>
                <td>{{ getAccountName(item.data.accountId) }}</td>
                <td>
                  <span class="transaction-type" [class]="getTransactionTypeClass(item.data.type)">
                    {{ item.data.type }}
                    <span *ngIf="item.data.type === 'Transferencia Interna'" class="transfer-arrow">
                      <i class="fas fa-arrow-right"></i>
                      <span *ngIf="getTargetAccountName(item.data) === 'Cargando...'" class="loading-text">
                        <i class="fas fa-spinner fa-spin"></i> Cargando...
                      </span>
                      <span *ngIf="getTargetAccountName(item.data) !== 'Cargando...'">
                        {{ getTargetAccountName(item.data) }}
                      </span>
                    </span>
                  </span>
                </td>
                <td class="text-right" [class]="getTransactionTypeClass(item.data.type)">
                  {{ getTransactionAmountDisplay(item.data) }}
                </td>
                <td>{{ item.data.currency }}</td>
                <td>{{ getTransactionDescription(item.data) }}</td>
                <td style="font-size: var(--font-xs);">{{ getUserName(item.data) }}</td>
              </ng-container>

              <!-- Exchange rate change rows -->
              <ng-container *ngIf="item.type === 'exchange-rate-change'">
                <td style="font-family: monospace; font-size: var(--font-xs);">
                  {{ formatDate(item.data.timestamp) }}
                </td>
                <td>
                  <span class="exchange-rate-indicator">
                    <i class="fas fa-exchange-alt"></i>
                    Configuración
                  </span>
                </td>
                <td>
                  <span class="exchange-rate-type">Cambio de tasa</span>
                </td>
                <td class="text-right">
                  <span class="exchange-rate-change">
                    {{ item.data.currency }}: {{ item.data.oldRate.toFixed(4) }} → {{ item.data.newRate.toFixed(4) }}
                  </span>
                </td>
                <td>USD</td>
                <td>
                  <span class="exchange-rate-description">
                    Tasa de cambio actualizada para {{ item.data.currency }}
                  </span>
                </td>
                <td style="font-size: var(--font-xs);">{{ getChangedByName(item.data) }}</td>
              </ng-container>
            </tr>
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="flex-between" style="margin-top: var(--space-4); padding-top: var(--space-3); border-top: 1px solid var(--border-color);">
          <div style="font-size: var(--font-sm); color: var(--color-gray-500);">
            Página {{ currentPage }} de {{ getTotalPages() }} ({{ totalItems }} total)
          </div>
          
          <div style="display: flex; gap: var(--space-1);">
            <button class="btn btn-sm" [disabled]="loading || currentPage === 1" (click)="changePage(currentPage - 1)">
              Anterior
            </button>
            
            <button *ngFor="let page of getPageNumbers()" 
                    class="btn btn-sm" 
                    [class.btn-primary]="page === currentPage"
                    [disabled]="loading"
                    (click)="changePage(page)">
              {{ page }}
            </button>
            
            <button class="btn btn-sm" [disabled]="loading || currentPage === getTotalPages()" (click)="changePage(currentPage + 1)">
              Siguiente
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>