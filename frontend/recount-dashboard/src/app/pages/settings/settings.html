<div page-content>

  <!-- Toast Notifications -->
  <div class="toast-container">
    <div *ngFor="let toast of toasts"
         [class]="'toast toast-' + toast.type + ' ' + (toast.show ? 'toast-show' : '')">
      <div class="toast-icon">
        <i [class]="toast.type === 'success' ? 'fas fa-check-circle' : 'fas fa-exclamation-circle'"></i>
      </div>
      <div class="toast-content">
        <div class="toast-message">{{ toast.message }}</div>
      </div>
      <button class="toast-close" (click)="removeToast(toast.id)">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>
  
  <!-- User Preferences Section -->
  <div style="margin-bottom: var(--space-6);">
    <h3 style="margin-bottom: var(--space-3); color: var(--text-primary);">Preferencias</h3>
    <div class="form-group" style="max-width: 300px;">
      <label class="form-label">Moneda base</label>
      <select [(ngModel)]="preferredCurrency"
              (change)="onPreferredCurrencyChange()"
              class="form-control">
        <option *ngFor="let currency of availableCurrencies" [value]="currency">
          {{ currency }}
        </option>
      </select>
    </div>
  </div>

  <!-- Exchange Rates Section (Only for admin/reviewer) -->
  <div *ngIf="canEditRates" style="margin-bottom: var(--space-6);">
    <div class="flex-between" style="margin-bottom: var(--space-3);">
      <h3 style="color: var(--text-primary);">Tasas de Cambio</h3>
      <button class="btn btn-sm" (click)="loadHistory()" [disabled]="loadingHistory">
        <i class="fas" [class.fa-history]="!showHistory" [class.fa-times]="showHistory"></i>
        {{ showHistory ? 'Ocultar' : 'Ver' }} Historial
      </button>
    </div>

      <div *ngIf="loadingRates" class="loading-container">
        <span class="loading"></span>
        <p>Cargando tasas de cambio...</p>
      </div>

      <!-- Error state when no rates are loaded -->
      <div *ngIf="!loadingRates && !hasExchangeRates" class="text-center text-muted" style="padding: var(--space-4);">
        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
        <p>No se pudieron cargar las tasas de cambio.</p>
        <button class="btn btn-sm btn-primary" (click)="loadExchangeRates()" [disabled]="loadingRates">
          <i class="fas fa-refresh"></i> Reintentar
        </button>
      </div>

      <div *ngIf="!loadingRates && exchangeRates.length > 0" class="rates-grid">
        <div *ngFor="let rate of exchangeRates" class="rate-item" [class.rate-new]="!rate._id">
          <div class="rate-currency">
            <strong>{{ rate.currency }}</strong>
            <div class="rate-status" *ngIf="!rate._id">
              <i class="fas fa-exclamation-triangle"></i>
              <span>No configurado</span>
            </div>
            <span class="rate-updated" *ngIf="rate._id">
              Actualizado: {{ formatDate(rate.updatedAt) }}
            </span>
            <span class="rate-updatedby" *ngIf="rate._id">
              Por: {{ getUpdatedByName(rate) }}
            </span>
          </div>

          <div class="rate-input-group">
            <label class="form-label">Tasa a USD</label>
            <div class="rate-current-value" *ngIf="rate._id">
              Valor actual: <strong>{{ rate.rateToUSD.toFixed(4) }}</strong>
            </div>
            <input type="number"
                   [(ngModel)]="editingRates[rate.currency]"
                   [disabled]="savingRates"
                   class="form-control"
                   step="0.0001"
                   min="0">
          </div>

          <div class="rate-actions">
            <button class="btn btn-primary btn-sm"
                    (click)="updateRate(rate.currency)"
                    [disabled]="savingRates">
              <i class="fas fa-save"></i>
              {{ rate._id ? 'Actualizar' : 'Crear' }}
            </button>
            <button class="btn btn-sm"
                    (click)="resetRate(rate.currency)"
                    [disabled]="savingRates">
              <i class="fas fa-undo"></i>
              Resetear
            </button>
          </div>
        </div>
      </div>

      <p class="help-text" style="margin-bottom: var(--space-4);">
        Las tasas se expresan como el valor de conversi√≥n a USD. Por ejemplo, si 1 USD = 1000 ARS, 
        la tasa para PESOS debe ser 0.001.
      </p>

      <!-- History Section -->
      <div *ngIf="showHistory" class="history-section">
        <h4 style="margin-top: var(--space-4); margin-bottom: var(--space-3);">
          Historial de Cambios
        </h4>

        <div *ngIf="loadingHistory" class="loading-container">
          <span class="loading"></span>
          <p>Cargando historial...</p>
        </div>

        <div *ngIf="!loadingHistory && rateHistory.length === 0" class="empty-state">
          <p>No hay historial de cambios disponible.</p>
        </div>

        <div *ngIf="!loadingHistory && rateHistory.length > 0" class="table-responsive">
          <table class="table">
            <thead>
              <tr>
                <th>Fecha</th>
                <th>Moneda</th>
                <th>Tasa Anterior</th>
                <th>Nueva Tasa</th>
                <th>Cambiado Por</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let item of rateHistory">
                <td>{{ formatDate(item.timestamp) }}</td>
                <td><strong>{{ item.currency }}</strong></td>
                <td>{{ item.oldRate.toFixed(4) }}</td>
                <td>{{ item.newRate.toFixed(4) }}</td>
                <td>{{ getChangedByName(item) }}</td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>

  </div>

  <!-- Info section for non-admin users -->
  <div *ngIf="!canEditRates">
    <h3 style="margin-bottom: var(--space-3); color: var(--text-primary);">Tasas de Cambio</h3>
      <div *ngIf="loadingRates" class="loading-container">
        <span class="loading"></span>
        <p>Cargando tasas de cambio...</p>
      </div>

      <!-- Error state for read-only users -->
      <div *ngIf="!loadingRates && !hasExchangeRates" class="text-center text-muted" style="padding: var(--space-4);">
        <i class="fas fa-exclamation-triangle text-warning" style="font-size: 2rem; margin-bottom: var(--space-2);"></i>
        <p>No se pudieron cargar las tasas de cambio.</p>
        <button class="btn btn-sm btn-primary" (click)="loadExchangeRates()" [disabled]="loadingRates">
          <i class="fas fa-refresh"></i> Reintentar
        </button>
      </div>

      <div *ngIf="!loadingRates && exchangeRates.length > 0" class="rates-display">
        <p class="help-text" style="margin-bottom: var(--space-3);">
          Tasas de cambio actuales utilizadas en el sistema:
        </p>
        <div *ngFor="let rate of exchangeRates" class="rate-display-item">
          <span class="rate-currency-name">{{ rate.currency }}</span>
          <span class="rate-value">{{ rate.rateToUSD.toFixed(4) }} USD</span>
          <span class="rate-updated-small">Actualizado: {{ formatDate(rate.updatedAt) }}</span>
        </div>
      </div>
  </div>

</div>
